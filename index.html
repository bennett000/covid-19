<!DOCTYPE html>
<html>
    <head>
        <title>Covid 19</title>
        <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
        <link rel="manifest" href="site.webmanifest">
        <style>
            html, body {
                border: 0;
                margin: 0;
                padding: 0;
                font-family: sans-serif;
            }
            .border {
                border-width: 1px;
                border-color: black;
                border-style: solid;
            }
            .controls {
                display: flex;
                justify-content: center;
                align-content: space-evenly;
            }
            .green {
                background-color: #22CC77;
            }
            .small-text {
                font-size: 0.85em;
            }
            select, input, button {
                margin: 2px;
                font-size: 1.3em;
                border: 1px solid #aaa;
                box-shadow: 0 1px 0 1px rgba(0,0,0,.04);
                border-radius: .5em;
                padding: .6em 1.4em .5em .8em;
            }
            .select-data, .select-country, input {
                background-color: #fff;
            }
            .select-country {
                height: 11em;
            }
        </style>
    </head>
    <body>
        <span class="small-text">COVID-19
            <a href="https://github.com/CSSEGISandData/COVID-19" target="_blank" title="GitHub repository of source data maintained by John Hopkins University">John Hopkins University Source Data</a> 
            Explorer (<a href="https://github.com/bennett000/covid-19" target="_blank" title="Source code to this website">source code</a>)
        </span>
        <script src="https://code.jscharting.com/latest/jscharting.js"></script>
        <script>
            const fullSize = 'width: 100%; height: 400px;';
            const defaultDataset = 0;
            const defaultCountry = 1;
            const defaultMode = 2;
            const defaultStart = "2019-12-26";
            const modes = [
                'By date',
                'By first confirmed',
                'By first 100 confirmed',
            ];
            const totalString = 'Total';
            const urls = [
                'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv',
                'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv',
                'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv',
            ];

            main();

            function createState(html) {
                return {
                    dataPromise: fetchData()
                        .then(setCountryOptions(html)),
                    dataSetIndexes: [defaultDataset],
                    countryIndexes: [defaultCountry],
                    html,
                    mode: defaultMode,
                    startDate: defaultStart,
                };
            }
            
            function main() {
                const html = createHtml();
                const state = createState(html);

                bindControls(state);
                selectData(state);
            }

            function bindControls(state) {
                state.html.reloadData.addEventListener('click', () => {
                    state.dataPromise = fetchData(setCountryOptions(state.html));
                    selectData(state);
                });

                const changeCountry = (e) => {
                    state.countryIndexes = selectedOptionsToArray(e.target.options);
                    selectData(state);
                };

                const changeData = (e) => {
                    state.dataSetIndexes = selectedOptionsToArray(e.target.options);
                    selectData(state);
                };

                const changeDate = (e) => {
                    state.startDate = e.target.value;
                    selectData(state);
                };

                const changeMode = (e) => {
                    state.mode = parseInt(e.target.value, 10);
                    selectData(state);
                }

                state.html.inputStart.addEventListener('change', changeDate);
                state.html.selectCountry.addEventListener('change', changeCountry);
                state.html.selectData.addEventListener('change', changeData);
                state.html.selectMode.addEventListener('change', changeMode);
            }

            function selectData(state) {
                startDate = new Date(state.startDate);
                state.dataPromise.then(({ points }) => {
                    const series = state.dataSetIndexes.reduce((s, dataSetIndex) => {
                        return points[dataSetIndex].reduce((si, country, i) => {
                            const dp = selectDataPointByMode(state, country, i);
                            if (dp) {
                                si.push(dp);
                            }
                            return si;
                        }, s);
                    }, []);
                    drawCurve(series, state.html, state.mode === 0 ? false : true);
                })
                .catch(console.log.bind(console));
            }

            function selectDataPointByMode(state, country, i) {
                switch (state.mode) {
                    case 1:
                        return selectDataPointByConfirmed(state, country, i, 1);
                    case 2:
                        return selectDataPointByConfirmed(state, country, i, 100);
                    default: 
                        return selectDataPointByDate(state, country, i);
                }
            }

            function selectDataPointByDate(state, country, i) {
                if (state.countryIndexes.indexOf(i + 1) > -1) {
                    console.log('by date');
                    return {
                        name: country.name,
                        points: country.points.map((p) => {
                            if (p.x > startDate) {
                                return p;
                            }
                            return null;
                        }).filter(Boolean),
                    };
                }
            }

            function selectDataPointByConfirmed(state, country, i, min) {
                if (state.countryIndexes.indexOf(i + 1) > -1) {
                    let newX = 0;
                    return {
                        name: country.name,
                        points: country.points.map((p) => {
                            if (p.x > startDate) {
                                if (p.y >= min) {
                                    const x = newX;
                                    newX += 1;
                                    return {
                                        x,
                                        y: p.y,
                                    };
                                }
                                return null;
                            }
                            return null;
                        }).filter(Boolean),
                    };
                }
            }

            function fetchData() {
                return Promise.all(urls.map((url) => JSC.fetch(url)))
                    .then(unboxResponses)
                    .then(convertToCsv)
                    .then(alphabetize)
                    .then(sumRegions)
                    // re alphabetize to integrate countries
                    .then(alphabetize)
                    .then(extractCountries)
                    .then(csvToPoints);
            }

            function createHtml() {
                const container = window.document.createElement('div');
                container.style = fullSize;

                const controls = window.document.createElement('section');
                controls.className = 'controls';
                container.appendChild(controls);

                const selectMode = createSelectModeComponent(controls); 

                const inputStart = window.document.createElement('input');
                inputStart.type = 'date';
                inputStart.value = defaultStart;
                controls.appendChild(inputStart);

                const selectData = createSelectDataComponent(controls);

                const selectCountry = window.document.createElement('select');
                selectCountry.multiple = true;
                selectCountry.className = 'select-country';
                controls.appendChild(selectCountry);

                const reloadData = window.document.createElement('button');
                reloadData.innerHTML = 'Reload Data';
                reloadData.className = 'green';
                controls.appendChild(reloadData);

                const chart = createChartComponent(container, controls);

                window.document.body.appendChild(container);

                return {
                    chart,
                    container,
                    controls,
                    inputStart,
                    selectCountry,
                    selectData,
                    selectMode,
                    reloadData,
                }
            }

            function setCountryOptions(html) {
                return (data) => {
                    const { countries } = data;
                    html.selectCountry.innerHTML = '';
                    const opts = createHtmlOptions(countries, defaultCountry)
                        .forEach((node) => {
                            html.selectCountry.appendChild(node)
                        });

                    return data;
                };
            }

            function createSelectDataComponent(container) {
                const selectData = window.document.createElement('select');
                selectData.multiple = true;
                selectData.className = 'select-data';
                createHtmlOptions(['Confirmed Cases', 'Deaths', 'Recoveries'], defaultDataset)
                    .forEach((node) => {
                        selectData.appendChild(node);
                    });
                container.appendChild(selectData)
                return selectData;
            }

            function createSelectModeComponent(controls) {
                const selectMode = window.document.createElement('select');
                createHtmlOptions(modes, defaultMode)
                    .forEach((node) => {
                        selectMode.appendChild(node);
                    });
                controls.appendChild(selectMode);
                return selectMode;
            }

            function createChartComponent(container, sibling) {
                const chart = window.document.createElement('div');
                chart.style = fullSize;
                chart.id = 'chartDiv';
                container.insertBefore(chart, sibling);
                return chart;
            }

            function createHtmlOptions(arr, selected) {
                return arr.map((el, i) => {
                    const opt = window.document.createElement('option');
                    if (typeof el === 'object') {
                        opt.value = el.index;
                        opt.innerHTML = el.name;
                        if (el.index === selected) {
                            opt.selected = true;
                        }
                    } else {
                        opt.value = i;
                        opt.innerHTML = el;
                        if (i === selected) {
                            opt.selected = true;
                        }
                    }
                    return opt;
                });
            }

            function selectedOptionsToArray(options) {
                let results = [];
                for (let i = 0; i < options.length; i += 1) {
                    const opt = options[i];
                    if (opt.selected) {
                        results.push(parseInt(opt.value, 10));
                    }
                }
                return results;
            }


            function sumRegions(dataSets) {
                // must be used after alphabetizing
                return dataSets.map((dataSet) => {
                    let sum = [];
                    let count = 0;
                    const resetSum = (row) => {
                        sum = row.slice(0);
                        sum[0] = totalString;
                    };
                    const incrementSum = (row) => {
                        for (let i = 4; i < row.length; i += 1) {
                            sum[i] += row[i];
                        }
                    };
                    return dataSet.concat(dataSet.reduce((totals, row, i, arr) => {
                        if (i === 0) {
                            return totals;
                        }
                        if (i === 1) {
                            resetSum(row);
                            return totals;
                        }
                        if (arr[i - 1][1] === row[1]) {
                            count += 1;
                            incrementSum(row);
                            return totals;
                        } else {
                            if (count > 1) {
                                totals.push(sum);
                            }
                            count = 0;
                            resetSum(row);
                            return totals;
                        }
                    }, []));
                });
            }

            function unboxResponses(responses) {
                return Promise.all(responses.map(r => r.text()));
            }

            function replaceCommasInQuotes(input) {
                if (/"[A-Za-z0-9\s\.']+(,)/.test(input)) {
                    if (input.charAt(0) === ',') {
                        const index = input.indexOf(',', 1);
                        return input.substr(0, index) + ';' + input.substr(index + 1);
                    }
                    return replaceCommasInQuotes(input.replace(',', ';'));
                }
                return input;
            }

            function convertToCsv(strings) {
                return strings.map((s) => s
                    .split('\n')
                    .map((row, rowIndex) => replaceCommasInQuotes(row)
                        .split(',')
                        .map((el, i) => {
                            if (i === 0) {
                                return el;
                            }
                            if (i === 1) {
                                return el;
                            }
                            if (rowIndex === 0) {
                                if (i > 3) {
                                    return new Date(el);
                                }
                                return el;
                            }
                            if (i > 3) {
                                return parseInt(el, 10);
                            }
                            return el;
                        })));
            }

            function alphabetize(dataSets) {
                return dataSets.map((dataSet) => {
                    const titles = dataSet.shift();
                    dataSet.sort((a, b) => {
                        if (a[1] < b[1]) {
                            return -1;
                        }
                        if (a[1] > b[1]) {
                            return 1;
                        }
                        if (a[0] < b[0]) {
                            return -1;
                        }
                        if (a[0] > b[0]) {
                            return 1;
                        }
                        return 0;
                    });

                    return [titles].concat(dataSet);
                });
            }

            function extractCountries(dataSets) {
                const countries = dataSets[0].reduce((countryArr, row, i) => {
                    if (i === 0) {
                        return countryArr;
                    }
                    if (row.length < 5) {
                        return countryArr;
                    }
                    if (row[0] === totalString) {
                        countryArr.push({ index: i, name: row[1] });
                        return countryArr;
                    }
                    if (!row[0]) {
                        countryArr.push({ index: i, name: row[1] });
                    }
                    return countryArr;
                }, []);

                return { countries, dataSets };
            }

            function getChartTypeFromIndex(index) {
                switch (index) {
                    case 0:
                        return '😷';
                    case 1:
                        return '☠';
                    default:
                        return '😊';
                }
            }

            function csvToPoints({ countries, dataSets }) {
                const points = dataSets.map((dataSet, dataSetIndex) => {
                    const chartType = getChartTypeFromIndex(dataSetIndex);
                    const series = [];
                    for (let i = 1; i < dataSet.length; i += 1) {
                        let name = '';
                        let points = [];
                        let row = dataSet[i];

                        for (let j = 0; j < row.length; j += 1) {
                            if (j === 1) {
                                name = chartType + ' ' + row[1] + ', ' + row[0];
                            }
                            if (j > 3) {
                                if (!row[j] || row[j] !== row[j]) {
                                    continue;
                                }
                                points.push({
                                    x: new Date(dataSet[0][j]),
                                    y: row[j],
                                });
                            }
                        }
                        series.push({
                            name, points
                        });
                    }
                    return series;
                });
                return { countries, dataSets, points };
            }

            function drawCurve(series, html, useDays) {
                console.log('chart data', series);
                JSC.Chart('chartDiv', {
                    xAxis_label_text: useDays ? 'Days' : undefined,
                    xAxis: {
                        scaleType: 'time',
                        customTicks: [{
                            // A tick for every month.
                            value: {
                            month: "*"
                            },
                            label_text: "%min"
                        },
                        {
                            // every month
                            value: { week: "*" },
                            label_text: '%min',
                        },
                        ]
                    },
                    legend: {
                        template: '%icon %name',
                    },
                    series, 
                });
            }

            function logp(i) {
                console.log(i.map(n => n.text()));
                return i;
            }
        </script>
    </body>
</html>
